---
- name: Install packages
  ansible.builtin.package:
    name: "{{ ubuntu_installer_packages }}"
    state: "{{ ubuntu_installer_package_state }}"

- name: Create temporary target directory
  ansible.builtin.tempfile:
    state: directory
    prefix: iso
  register: tmpdir_dest

- name: Create image target directory
  ansible.builtin.file:
    state: directory
    path: "{{ ubuntu_installer_target_dir }}"

- name: Fetch ubuntu source iso
  ansible.builtin.get_url:
    url: "{{ ubuntu_installer_image_url }}"
    dest: "{{ ubuntu_installer_iso_path }}"

- name: Create temporary mount fstab
  ansible.builtin.tempfile:
    state: directory
    prefix: fstab
  register: mntfile_dest

- name: Create temporary mount directory
  ansible.builtin.tempfile:
    state: directory
    prefix: mnt
  register: mntdir_dest

- name: Copy ISO contents
  block:

    - name: Mount ubuntu source iso
      ansible.posix.mount:
        src: "{{ ubuntu_installer_iso_path }}"
        path: "{{ mntdir_dest.path }}"
        state: mounted
        opts: loop
        fstype: iso9660

    - name: Copy ISO files
      ansible.builtin.command: "cp -a {{ mntdir_dest.path }}/. {{ tmpdir_dest.path }}/"
      tags:  skip_ansible_lint

  always:

    - name: Unmount ubuntu source iso
      ansible.posix.mount:
        src: "{{ ubuntu_installer_iso_path }}"
        path: "{{ mntdir_dest.path }}"
        state: absent
        opts: loop

- name: Remove ubuntu source iso
  ansible.builtin.file:
    path: "{{ ubuntu_installer_iso_path }}"
    state: absent

- name: Remove temporary mount directory
  ansible.builtin.file:
    path: "{{ mntdir_dest.path }}"
    state: absent

- name: Remove temporary mount fstab
  ansible.builtin.file:
    path: "{{ mntfile_dest.path }}"
    state: absent

- name: Run version installer tasks
  ansible.builtin.include_tasks: live.yml

- name: Remove temporary directories
  ansible.builtin.file:
    path: "{{ tmpdir_dest.path }}"
    state: absent
